Perfect—Phase 6 it is. Below are **copy-pasteable implementation instructions** for the Replit AI assistant. They assume we already have Phases 1–5 in place. The key rule for this phase: **responses must be base64 only** (no URL mode, no file-serve dependency).

---

# Phase 6 — Return Contract Finalization (Base64-only)

## Goal (tell Replit):

Standardize both heatmap endpoints to **always** return:

```json
{
  "base64": "data:image/png;base64,....",
  "meta": {
    "sourceUrl": "<string>",
    "device": "desktop|tablet|mobile",
    "viewport": { "width": <number>, "height": <number> },
    "engine": "ai|data",
    "durationMs": <number>,
    "timestamp": "<ISO8601>"
  }
}
```

* **No URL responses**, no `returnMode` parameter, no reliance on `/public/heatmaps`.

---

## 1) File updates (paths in repo root)

* `server/services/heatmap.ts`
* `server/app-routes.ts`
* (Optional) `server/index.ts` (we will **not** remove static serving if it already exists; just don’t use it)

---

## 2) Service contract changes

**Edit: `server/services/heatmap.ts`**

1. **Exports to maintain**

   * `generateHeatmap(params)` — AI-assisted hotspots → render → base64.
   * `generateDataHeatmap(params)` — data points → render → base64.

2. **Parameter shape (both functions)**

   ```ts
   type Device = "desktop" | "tablet" | "mobile";
   interface HeatmapArgs {
     url: string;
     device?: Device;         // default "desktop"
     // dataPoints?: only for generateDataHeatmap
   }
   ```

   * Remove `mode`, `returnMode`, and any previous `"base64" | "url"` pathways.
   * Device controls viewport mapping:

     * desktop: 1920×1080
     * tablet: 1024×768
     * mobile: 414×896

3. **Base64 only**

   * Ensure the final step **does not** write PNG to disk.
   * Return **inline** `data:image/png;base64,...` from the canvas buffer directly.
   * Remove/disable any code that builds filesystem paths for heatmaps (keep it if used elsewhere, but not used here).

4. **Meta**

   * Always include `engine: "ai"` in `generateHeatmap()`, `engine: "data"` in `generateDataHeatmap()`.
   * Include `durationMs` (measure inside the function), `timestamp` (new Date().toISOString()).
   * Include the resolved `device` and its `viewport`.

5. **Validation & defaults**

   * If `device` not provided → default `"desktop"`.
   * If URL missing or malformed → throw a typed error (the route will catch and 4xx/5xx).
   * In `generateDataHeatmap`, require `dataPoints` as an `Array` with `0..1` normalized coordinates; sanitize values into bounds.

> Acceptance notes for Replit: After you apply, `generateHeatmap()` and `generateDataHeatmap()` must **never** branch on URL mode and must **never** return a filesystem URL; only base64.

---

## 3) Route layer alignment

**Edit: `server/app-routes.ts`**

1. **/api/v1/heatmap**

   * Accept JSON body: `{ url: string, device?: "desktop"|"tablet"|"mobile" }`.
   * Validate: `url` present; `device` in the allowed set (or default to desktop).
   * Call:

     ```ts
     const { generateHeatmap } = await import("./services/heatmap");
     const result = await generateHeatmap({ url, device });
     return res.json(result);
     ```
   * Do **not** accept `returnMode`. If present, **ignore** it.

2. **/api/v1/heatmap/data**

   * Accept JSON body: `{ url: string, dataPoints: Array<{x:number,y:number,type?:string}>, device?: ... }`.
   * Validate `dataPoints` is an array and clamp values inside the service.
   * Call:

     ```ts
     const { generateDataHeatmap } = await import("./services/heatmap");
     const result = await generateDataHeatmap({ url, device, dataPoints });
     return res.json(result);
     ```

3. **Error semantics**

   * Missing URL → `400 { error: "URL is required" }`
   * Bad dataPoints → `400 { error: "dataPoints[] required" }`
   * Internal failures → `500 { error: "Failed to generate heatmap" }` (log the underlying message)

> Acceptance notes for Replit: The two endpoints must return **exactly** the unified response shape (see Goal), always with a `"base64"` field and `"meta"`.

---

## 4) Remove URL-path code paths

* In `server/services/heatmap.ts`, delete/disable any `if (mode === "url")` logic and any `fs.writeFile` for product images.
* You **can** keep `/heatmaps` static serving in `server/index.ts` if other features use it, but this phase **must not** depend on it.

---

## 5) Logging & timing

* Inside both service functions, capture `const t0 = Date.now();` and set `durationMs = Date.now() - t0` in `meta`.
* Log one structured line on success with: `{ endpoint, device, durationMs, width, height, sourceUrl }`.
* Log one structured line on error with error class and message.

---

## 6) Schema summary (for docs and future tests)

**/api/v1/heatmap — Request**

```json
{
  "url": "https://www.example.com",
  "device": "desktop"
}
```

**/api/v1/heatmap/data — Request**

```json
{
  "url": "https://www.example.com",
  "device": "mobile",
  "dataPoints": [
    { "x": 0.52, "y": 0.18, "type": "click" },
    { "x": 0.47, "y": 0.66, "type": "move" }
  ]
}
```

**Both — Response (base64-only)**

```json
{
  "base64": "data:image/png;base64,iVBORw0K...",
  "meta": {
    "sourceUrl": "https://www.example.com",
    "device": "mobile",
    "viewport": { "width": 414, "height": 896 },
    "engine": "ai",
    "durationMs": 742,
    "timestamp": "2025-09-08T15:04:05.000Z"
  }
}
```

---

## 7) Definition of Done (Replit must verify)

* [ ] Both endpoints return **only** `base64` with the unified envelope.
* [ ] No code path attempts to save PNGs to disk for return.
* [ ] Passing an unknown `device` still returns a valid image using desktop defaults.
* [ ] `/api/v1/heatmap` works on at least 2 public URLs.
* [ ] `/api/v1/heatmap/data` renders visible hot regions with a small synthetic `dataPoints` set.
* [ ] Logs include duration and device for each request.

---

## 8) Quick smoke tests (assistant can run)

**AI endpoint**

```bash
curl -sS -X POST http://localhost:3000/api/v1/heatmap \
  -H "Content-Type: application/json" \
  -d '{"url":"https://www.acquisition.com","device":"desktop"}' | jq -r '.base64' | head -c 60
```

(Expect output: starts with `data:image/png;base64,`)

**Data endpoint**

```bash
curl -sS -X POST http://localhost:3000/api/v1/heatmap/data \
  -H "Content-Type: application/json" \
  -d '{"url":"https://example.com","device":"mobile","dataPoints":[{"x":0.5,"y":0.2},{"x":0.52,"y":0.22},{"x":0.48,"y":0.24}]}' \
  | jq -r '.base64' | head -c 60
```

---

## 9) Don’ts (important)

* ❌ Do **not** return URLs or rely on `/public/heatmaps` for the response.
* ❌ Do **not** accept or document `returnMode`.
* ❌ Do **not** change the envelope shape between endpoints.

---

If you want, next I can generate a tiny “Phase 6 test harness” snippet (a dev page or script) that displays the returned base64 in an `<img>` for instant visual verification—just say the word.
